<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Archivo y Cámara con Predicción</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <h1 class="mt-5 text-center">Detector de frutas</h1>

        <!-- Sección para subir archivo -->
        <div class="mb-2 row">
            <h2>Subir Archivo</h2>
            <form id="upload-form" enctype="multipart/form-data">
                <div class="col-md-6">
                    <input type="file" name="file" accept=".jpg, .jpeg, .png" class="form-control">
                </div>
                <div class="col-md-6 pt-2">
                    <input type="button" value="Subir y Predecir" onclick="uploadFile()" class="btn btn-primary">
                </div>
            </form>
        </div>
    </div>

    <!-- Sección para la cámara -->
    <div class="mb-3 row">
        <h2 class="text-center">Cámara</h2>
        <div class="col-md-6 offset-md-3 text-center"> <!-- Centrar el contenido -->
            <div id="prediction-result"></div>
        </div>
        <div class="text-center pb-2">
            <button onclick="startCamera()" class="btn btn-success">Iniciar Cámara</button>
            <button onclick="stopCamera()" class="btn btn-danger">Detener Cámara y Limpiar Predicción</button>
        </div>
        <video id="camera" width="640" height="480" autoplay></video>

        <script>
            var video;
            var isCameraActive = false;

            function startCamera() {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function (stream) {
                        video = document.getElementById('camera');
                        video.srcObject = stream;
                        video.play();

                        isCameraActive = true;

                        var predictionResult = document.getElementById('prediction-result');

                        var canvas = document.createElement('canvas');
                        var context = canvas.getContext('2d');

                        // Función para preprocesar la imagen y realizar la predicción
                        function predict() {
                            // Verificar si la cámara sigue activa
                            if (!isCameraActive) {
                                return;
                            }

                            context.drawImage(video, 0, 0, canvas.width, canvas.height);

                            // Obtener los datos binarios de la imagen
                            canvas.toBlob(function (blob) {
                                // Crear un objeto FormData para enviar los datos
                                var formData = new FormData();
                                formData.append('file', blob, 'frame.jpg');

                                // Enviar la imagen al servidor
                                $.ajax({
                                    type: 'POST',
                                    url: '/upload', // Ruta del servidor para la predicción
                                    data: formData,
                                    processData: false,
                                    contentType: false,
                                    success: function (response) {
                                        console.log(response);
                                        predictionResult.innerHTML = '<h1>Resultado de la predicción: ' + response.prediction + '</h1>';

                                        // Agregar un retraso de 1 segundo (1000 milisegundos) antes de la próxima predicción
                                        setTimeout(function () {
                                            requestAnimationFrame(predict);
                                        }, 1000);
                                    },
                                    error: function (error) {
                                        console.error(error);
                                    }
                                });
                            }, 'image/jpeg');
                        }

                        // Iniciar la predicción en cada frame
                        requestAnimationFrame(predict);
                    })
                    .catch(function (error) {
                        console.error(error);
                    });
            }

            function stopCamera() {
                // Detener la transmisión de video
                if (video && video.srcObject) {
                    var tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    isCameraActive = false;
                    $("#prediction-result").html(''); // Limpiar la predicción al detener la cámara
                }
            }

            function uploadFile() {
                var fileInput = document.querySelector('input[type="file"]');
                var file = fileInput.files[0];

                if (file) {
                    var formData = new FormData();
                    formData.append('file', file);

                    // Enviar la imagen al servidor
                    $.ajax({
                        type: 'POST',
                        url: '/upload', // Ruta del servidor para la predicción
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            console.log(response);
                            $("#prediction-result").html('<h1>Resultado de la predicción: ' + response.prediction + '</h1>');
                        },
                        error: function (error) {
                            console.error(error);
                        }
                    });
                } else {
                    console.log('Seleccione un archivo antes de subir.');
                }
            }
        </script>
    </div>
</body>

</html>